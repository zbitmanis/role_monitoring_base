# container-prometheus.service

[Unit]
Description=Thanos compactor
Documentation=https://thanos.io
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Environment=THAN_DATA_DIR={{ thanos_data_dir }}
Environment=THAN_CONFIG_DIR={{ thanos_config_dir }}
Environment=THAN_RELEASE={{ thanos_release }}
Environment=PROM_UID={{ prometheus_uid }}
Environment=PROM_UID={{ prometheus_uid }}
Environment=THAN_OBJ_FILE={{ thanos_objstore_file }}
Environment=THAN_RET_RAW={{ thanos_retention_raw | default('30d') }}
Environment=THAN_RET_5M={{ thanos_retention_5m | default('90d') }}
Environment=THAN_RET_1H={{ thanos_retention_1h | default('1y') }}


Restart=on-failure
TimeoutStopSec=70
ExecStartPre=/bin/rm -f %t/%n.ctr-id
ExecStart=/usr/bin/podman run --cidfile=%t/%n.ctr-id --cgroups=no-conmon  --rm --sdnotify=conmon --replace  --user ${PROM_UID} -d  -p 10904:10904 -v ${THAN_CONFIG_DIR}:${THAN_CONFIG_DIR} -v ${THAN_DATA_DIR}:${THAN_DATA_DIR} --name thanos-compactor  quay.io/thanos/thanos:${THAN_RELEASE} compact --data-dir=${THAN_DATA_DIR} --objstore.config-file=${THAN_OBJ_FILE} --http-address=0.0.0.0:10904 --retention.resolution-raw=${THAN_RET_RAW} --retention.resolution-5m=${THAN_RET_5M} --retention.resolution-1h=${THAN_RET_1H}

ExecStop=/usr/bin/podman stop --ignore --cidfile=%t/%n.ctr-id
ExecStopPost=/usr/bin/podman rm -f --ignore --cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target
